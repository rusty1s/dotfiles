#!/bin/bash

MAX_RETRIES=10
SRC="$HOME/Downloads/credentials"
DST="$HOME/.aws/credentials"

if [ -f "$SRC" ]; then
  cp "$SRC" "$DST"
  chmod 600 "$DST"
fi

INSTANCE_ID="i-0c4bff4ee07dae8a2"
REGION="eu-central-1"

if ! STATE=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID} --region ${REGION} --query 'Reservations[0].Instances[0].State.Name' --output text 2>&1); then
    echo "Get AWS credentials at https://accounts.google.com/o/saml2/initsso?idpid=C02wy9doe&spid=619865309956&forceauthn=false."
    exit 1
fi
INSTANCE_TYPE=$(aws ec2 describe-instances --instance-ids ${INSTANCE_ID} --region ${REGION} --query 'Reservations[0].Instances[0].InstanceType' --output text)

if [ $# -eq 0 ]; then
  if [ "$STATE" != "running" ]; then
    echo "Starting ${INSTANCE_TYPE} instance..."
    COUNT=0
    while [ $COUNT -lt $MAX_RETRIES ]; do
      COUNT=$((COUNT+1))
      if OUTPUT=$(aws ec2 start-instances --instance-ids ${INSTANCE_ID} --region ${REGION} 2>&1); then
        break
      else
        if [ $COUNT -ge $MAX_RETRIES ]; then
          echo "[$COUNT/$MAX_RETRIES] Start failed, aborting"
          echo "$OUTPUT"
          exit 1
        fi
        echo "[$COUNT/$MAX_RETRIES] Start failed, retrying"
        sleep 5
      fi
    done
    echo "Waiting for instance to start..."
    aws ec2 wait instance-running --instance-ids ${INSTANCE_ID} --region ${REGION}
    echo "Instance started!"
  fi

  echo "Logging into ${INSTANCE_TYPE} instance..."
  ssh "$INSTANCE_ID"
  exit 0
fi

case "$1" in
  status)
    echo "Instance state: ${STATE}"
    echo "Instance type: ${INSTANCE_TYPE}"
    ;;
  connect)
    if [ "$STATE" != "running" ]; then
      echo "Instance not started yet!"
      exit 1
    fi
    echo "Logging into ${INSTANCE_TYPE} instance..."
    ssh "$INSTANCE_ID"
    ;;
  start)
    if [ "$STATE" == "running" ]; then
      echo "Instance already running!"
    else
      echo "Starting ${INSTANCE_TYPE} instance..."
      COUNT=0
      while [ $COUNT -lt $MAX_RETRIES ]; do
        COUNT=$((COUNT+1))
        if OUTPUT=$(aws ec2 start-instances --instance-ids ${INSTANCE_ID} --region ${REGION} 2>&1); then
          break
        else
          if [ $COUNT -ge $MAX_RETRIES ]; then
            echo "[$COUNT/$MAX_RETRIES] Start failed, aborting"
            echo "$OUTPUT"
            exit 1
          fi
          echo "[$COUNT/$MAX_RETRIES] Start failed, retrying"
          sleep 5
        fi
      done
      echo "Waiting for instance to start..."
      aws ec2 wait instance-running --instance-ids ${INSTANCE_ID} --region ${REGION}
      echo "Instance started!"
    fi
    ;;
  stop)
    if [ "$STATE" == "stopped" ]; then
      echo "Instance already stopped!"
    else
      echo "Stopping instance..."
      aws ec2 stop-instances --instance-ids ${INSTANCE_ID} --region ${REGION} > /dev/null
      echo "Waiting for graceful shutdown..."
      aws ec2 wait instance-stopped --instance-ids ${INSTANCE_ID} --region ${REGION}
      echo "Instance stopped!"
    fi
    ;;
  kill)
    if [ "$STATE" == "stopped" ]; then
      echo "Instance already stopped!"
    else
      echo "Force stopping instance..."
      aws ec2 stop-instances --instance-ids ${INSTANCE_ID} --region ${REGION} --force > /dev/null
      echo "Waiting for forced shutdown..."
      aws ec2 wait instance-stopped --instance-ids ${INSTANCE_ID} --region ${REGION}
      echo "Instance stopped!"
    fi
    ;;
  resize)
    if [ -z "$2" ]; then
      echo "Usage: ec2 resize <instance-type>"
      echo "Example: ec2 resize g6.xlarge"
      echo "  - g6.xlarge:    16GiB"
      echo "  - g6.2xlarge:   32GiB"
      echo "  - g6.4xlarge:   64GiB"
      echo "  - g6.8xlarge:  128GiB"
      echo "  - g6.12xlarge: 192GiB"
      echo "  - g6.16xlarge: 256GiB"
      echo "  - g6.24xlarge: 384GiB"
      echo "  - g6.48xlarge: 768GiB"
      exit 1
    fi
    if [ "$STATE" != "stopped" ]; then
      echo "Instance needs to be stopped to resize!"
      exit 1
    fi
    echo "Changing instance type to $2..."
    aws ec2 modify-instance-attribute --instance-id ${INSTANCE_ID} --instance-type $2 --region ${REGION}
    echo "Instance type changed!"
    ;;
  *)
    echo "Usage: ec2 [command]"
    echo ""
    echo "Commands:"
    echo "  (none)  - Connect (auto-starts if stopped)"
    echo "  status  - Show instance status"
    echo "  connect - Connect"
    echo "  start   - Start the instance"
    echo "  stop    - Stop the instance"
    echo "  kill    - Force stop the instance"
    echo "  resize  - Change instance type"
    exit 1
    ;;
esac
